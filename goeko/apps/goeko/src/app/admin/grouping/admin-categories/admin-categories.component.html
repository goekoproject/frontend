<div class="flex flex-col gap-6">
  <section class="flex flex-col gap-4">
    <h1 class="text-4xl">{{ classifications()?.name }}</h1>
    <p>
      {{ classifications()?.description }}
    </p>
  </section>
  @if (!classifications()) {
    <div>
      <button go-button (click)="createNewCategory()">
        {{ 'newCategory' | translate }}
      </button>
    </div>

    <ul role="list" class="">
      @for (category of allCategories(); track category.code) {
        <label [for]="category.code" class="ms-2 w-full text-sm font-medium text-gray-900 dark:text-gray-300">
          <li class="flex cursor-pointer justify-between gap-x-6 rounded-md border p-4 py-5">
            <div class="flex min-w-0 flex-col gap-x-4">
              <input
                #categoryRef
                [id]="category.code"
                [value]="JSON.stringify(category)"
                type="checkbox"
                value=""
                class="h-4 w-4 rounded border-gray-300 bg-gray-100 text-blue-600 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:ring-offset-gray-800 dark:focus:ring-blue-600" />

              <div class="flex min-w-0 flex-auto gap-4">
                @for (translation of category.label.translations; track translation.lang) {
                  <div class="flex flex-col justify-around gap-2">
                    <p class="text-sm font-semibold text-gray-900">{{ translation.label }}</p>
                    <p class="mt-1 truncate text-xs/5 text-gray-500">{{ translation.lang }}</p>
                  </div>
                }
              </div>

              @if (subcategories()?[0]?.categoryId === category.id) {
                <section>
                  <article>
                    <goeko-radio-group>
                      @for (lang of langs(); track lang.code) {
                        <goeko-radio-input
                          [value]="lang.code"
                          [name]="'lang'"
                          [id]="lang.code"
                          (click)="selectedLangSubcategory.set(lang.code)">
                          <span class="fi fi-{{ lang.iconFlag }}"></span>
                          <p>{{ lang.title | translate }}</p>
                        </goeko-radio-input>
                      }
                    </goeko-radio-group>
                  </article>
                  <ul>
                    @for (subcategory of subcategories(); track subcategory.id) {
                      <li>
                        <p>
                          {{ subcategory.label.translations | labelByCategory: selectedLangSubcategory() }}
                        </p>
                      </li>
                    }
                  </ul>
                </section>
              }
            </div>
            <div class="flex items-center gap-2">
              <button go-button appearance="flat" (click)="deleteCategory(category)">{{ 'delete' | translate }}</button>
              <button go-button appearance="white" (click)="viewSubcategory(category.id)">{{ 'Show Sub Category' | translate }}</button>

              <button go-button appearance="white" (click)="addNewSubcategoryToCategory(category)">
                <i class="ti ti-arrow-big-right-line"></i>
              </button>
            </div>
          </li>
        </label>
      }
    </ul>
  } @else {
    <section class="section-step">
      <!-- CATEGORY -->
      <goeko-category
        [editMode]="true"
        [categories]="categories() || []"
        [indexSelected]="0"
        (onSelectCategory)="selectCategory($event)"
        (onEditCategory)="editCategory($event)">
      </goeko-category>
    </section>

    <button go-button appearance="white" class="ml-auto" (click)="addSubcategory()">
      {{ 'Add' | translate }}
    </button>
    @defer (when form) {
      <section class="section-subcategories" [formGroup]="form" [@listAnimation]="subCategorySelected()?.subcategories?.length">
        @for (subcategory of subCategorySelected()?.subcategories; track subcategory.code; let index = $index) {
          <details [@fadeAnimation] class="subcategories" formGroupName="{{ subcategory.code }}" #detailCategory>
            <summary class="subcategories-summary" (click)="toogleSubcategory($event, index)">
              <p>
                {{ subcategory.label.translations[2].label }}
              </p>
              <p>( {{ subcategory.code }})</p>
            </summary>
            @defer (when detailCategory.open) {
              <div class="subcategories-body">
                <div class="flex flex-col gap-2 p-4">
                  <go-switch
                    class="button-toogle-actors"
                    (valueChanged)="hanldertoggleActor($event)"
                    [leftLabel]="'USER_TYPE.sme' | translate"
                    [rightLabel]="'USER_TYPE.cleanTech' | translate"></go-switch>
                  <!--Question for SME's-->
                  @if (toggleActor()) {
                    <section formGroupName="question">
                      <fieldset formArrayName="translations" class="subcategories-translations">
                        <legend class="section-legeng-subcategories">
                          {{ 'FORM_LABEL.subcategoryForLangSME' | translate }}
                        </legend>

                        @for (lang of langs(); track lang.code; let index = $index) {
                          <article [formGroupName]="index" class="subcategories-sentence">
                            <go-input [formControlName]="'label'">
                              <p slot="label">
                                <span class="fi fi-{{ lang.iconFlag }}"></span>
                                {{ lang.title | translate }}
                              </p>
                            </go-input>
                          </article>
                        }
                      </fieldset>
                    </section>
                  } @else {
                    <!--  Question for Cleantech-->
                    <section formGroupName="label">
                      <fieldset formArrayName="translations" class="subcategories-translations">
                        <legend class="section-legeng-subcategories">
                          {{ 'FORM_LABEL.subcategoryForLangCleantech' | translate }}
                        </legend>

                        @for (lang of langs(); track lang.code; let index = $index) {
                          <article [formGroupName]="index" class="subcategories-sentence">
                            <go-input [formControlName]="'label'">
                              <p slot="label">
                                <span class="fi fi-{{ lang.iconFlag }}"></span>
                                {{ lang.title }}
                              </p>
                            </go-input>
                          </article>
                        }
                      </fieldset>
                    </section>
                  }
                  <button go-button class="self-end" (click)="updateSubcategory(subcategory.id, this.form.value[subcategory.code])">
                    {{ 'update' | translate }}
                  </button>
                </div>

                <fieldset class="subcategories-translations bg-transparent">
                  <legend class="section-legeng-subcategories">
                    {{ 'FORM_LABEL.products' | translate }}
                  </legend>

                  <go-badge-group [id]="'products'" name="products">
                    @for (product of subcategory.products; track product.code) {
                      <go-badge [value]="product" [@fadeAnimation]>
                        <i
                          (click)="editProduct(subcategory, product)"
                          class="ti ti-pencil cursor-pointer rounded-full border p-2 text-2xl leading-6 hover:bg-blue-500 hover:text-white"
                          avatar></i>
                        {{ product | productToCurrentLang }}
                      </go-badge>
                    }
                    <button go-button class="self-center" (click)="addProducts(subcategory)">
                      <i class="ti ti-plus"></i> {{ 'add' | translate }}
                      {{ 'product' | translate }}
                    </button>
                  </go-badge-group>
                </fieldset>
                <div class="subcategories-actions">
                  <button go-button appearance="white" (click)="closeDetailCategory(index)">
                    {{ 'cancel' | translate }}
                  </button>
                </div>
              </div>
            }
          </details>
        }
      </section>
    } @loading {
      <div>loading</div>
    }
  }
</div>
